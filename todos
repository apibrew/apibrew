1. fix references
2. improve tests
3. improve logging
